version: "2.4"

services:
  odoo:
    extends:
      file: common.yaml
      service: odoo
    restart: unless-stopped
    env_file:
      - .docker/odoo.env
      - .docker/db-access.env
    environment:
      DOODBA_ENVIRONMENT: "${DOODBA_ENVIRONMENT-prod}"
      INITIAL_LANG: "$INITIAL_LANG"
    depends_on:
      - db
    networks:
      default:
      inverseproxy_shared:
    labels:
      traefik.longpolling.frontend.rule: "Host:${DOMAIN_PROD};PathPrefix:/longpolling/"
      traefik.www.frontend.rule: "Host:${DOMAIN_PROD}"
      # Main service
      ? traefik.http.middlewares.myproject-odoo-9-0-prod-main-buffering.buffering.retryExpression
      : "IsNetworkError() && Attempts() < 5"
      traefik.http.middlewares.myproject-odoo-9-0-prod-main-compress.compress: "true"
      traefik.http.routers.myproject-odoo-9-0-prod-main.entrypoints: "web-main"
      traefik.http.routers.myproject-odoo-9-0-prod-main.middlewares: "myproject-odoo-9-0-prod-main-compress,myproject-odoo-9-0-prod-main-buffering"
      traefik.http.routers.myproject-odoo-9-0-prod-main.rule: "host(`${DOMAIN_PROD}`)"
      traefik.http.routers.myproject-odoo-9-0-prod-main.service: "myproject-odoo-9-0-prod-main"
      traefik.http.routers.myproject-odoo-9-0-prod-main.tls: "true"
      traefik.http.routers.myproject-odoo-9-0-prod-main.tls.certresolver: "letsencrypt"
      traefik.http.services.myproject-odoo-9-0-prod-main.loadbalancer.server.port: 8069
      # Longpolling service
      traefik.http.routers.myproject-odoo-9-0-prod-longpolling.entrypoints: "web-main"
      traefik.http.routers.myproject-odoo-9-0-prod-longpolling.rule:
        "host(`${DOMAIN_PROD}`) && pathprefix(`/longpolling/`)"
      traefik.http.routers.myproject-odoo-9-0-prod-longpolling.service: "myproject-odoo-9-0-prod-longpolling"
      traefik.http.services.myproject-odoo-9-0-prod-longpolling.loadbalancer.server.port: 8072
      traefik.http.routers.myproject-odoo-9-0-prod-longpolling.tls: "true"
      traefik.http.routers.myproject-odoo-9-0-prod-longpolling.tls.certresolver: "letsencrypt"

  db:
    extends:
      file: common.yaml
      service: db
    env_file:
      - .docker/db-creation.env
    restart: unless-stopped

networks:
  default:
    driver_opts:
      encrypted: 1

  inverseproxy_shared:
    external: true

volumes:
  filestore:
  db:
